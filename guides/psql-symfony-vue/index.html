
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Erase environment differences, make developers happy !">
      
      
      
        <meta name="author" content="RÃ©mi Alvergnat <remi.alvergnat@gfi.world>, Pierre Lejeune <pierre.lejeune@gfi.world>">
      
      
        <link rel="canonical" href="https://gfi-centre-ouest.github.io/docker-devbox-ddb/guides/psql-symfony-vue/">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-6.2.5">
    
    
      
        <title>PostgreSQL, Symfony, VueJS - ddb (for Docker Devbox)</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.15aa0b43.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.75751829.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
      <link rel="stylesheet" href="../../css/extra.css">
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
      
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#guide" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="https://gfi-centre-ouest.github.io/docker-devbox-ddb" title="ddb (for Docker Devbox)" class="md-header-nav__button md-logo" aria-label="ddb (for Docker Devbox)">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      <div class="md-header-nav__ellipsis">
        <div class="md-header-nav__topic">
          <span class="md-ellipsis">
            ddb (for Docker Devbox)
          </span>
        </div>
        <div class="md-header-nav__topic">
          <span class="md-ellipsis">
            
              PostgreSQL, Symfony, VueJS
            
          </span>
        </div>
      </div>
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/gfi-centre-ouest/docker-devbox-ddb/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    




<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://gfi-centre-ouest.github.io/docker-devbox-ddb" title="ddb (for Docker Devbox)" class="md-nav__button md-logo" aria-label="ddb (for Docker Devbox)">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    ddb (for Docker Devbox)
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/gfi-centre-ouest/docker-devbox-ddb/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      


  
  
  
    <li class="md-nav__item">
      <a href="../../overview/" class="md-nav__link">
        Overview
      </a>
    </li>
  

    
      
      
      


  
  
  
    <li class="md-nav__item">
      <a href="../../configuration/" class="md-nav__link">
        Configuration
      </a>
    </li>
  

    
      
      
      


  
  
  
    <li class="md-nav__item">
      <a href="../../commands/" class="md-nav__link">
        Commands
      </a>
    </li>
  

    
      
      
      


  
  
  
    <li class="md-nav__item">
      <a href="../../templates/" class="md-nav__link">
        Templates
      </a>
    </li>
  

    
      
      
      


  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6" checked>
      
      <label class="md-nav__link" for="nav-6">
        Guides
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Guides" data-md-level="1">
        <label class="md-nav__title" for="nav-6">
          <span class="md-nav__icon md-icon"></span>
          Guides
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
          
            
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          PostgreSQL, Symfony, VueJS
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        PostgreSQL, Symfony, VueJS
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#create-empty-project-directory" class="md-nav__link">
    Create empty project directory
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setup-database" class="md-nav__link">
    Setup database
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#start-watch-mode" class="md-nav__link">
    Start watch mode
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#add-a-named-volume" class="md-nav__link">
    Add a named volume
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#register-binary-from-image" class="md-nav__link">
    Register binary from image
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#workaround-permission-issues" class="md-nav__link">
    Workaround permission issues
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setup-php-apache-and-symfony-skeleton" class="md-nav__link">
    Setup PHP, Apache and Symfony Skeleton
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setup-vuejs-and-vue-cli" class="md-nav__link">
    Setup VueJS and Vue CLI
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      


  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7" >
      
      <label class="md-nav__link" for="nav-7">
        Features
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Features" data-md-level="1">
        <label class="md-nav__title" for="nav-7">
          <span class="md-nav__icon md-icon"></span>
          Features
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../features/certs/" class="md-nav__link">
        certs
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../features/copy/" class="md-nav__link">
        copy
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../features/core/" class="md-nav__link">
        core
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../features/docker/" class="md-nav__link">
        docker
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../features/file/" class="md-nav__link">
        file
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../features/fixuid/" class="md-nav__link">
        fixuid
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../features/git/" class="md-nav__link">
        git
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../features/gitignore/" class="md-nav__link">
        gitignore
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../features/jinja/" class="md-nav__link">
        jinja
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../features/jsonnet/" class="md-nav__link">
        jsonnet
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../features/permissions/" class="md-nav__link">
        permissions
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../features/run/" class="md-nav__link">
        run
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../features/shell/" class="md-nav__link">
        shell
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../features/smartcd/" class="md-nav__link">
        smartcd
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../features/symlinks/" class="md-nav__link">
        symlinks
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../features/traefik/" class="md-nav__link">
        traefik
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../features/version/" class="md-nav__link">
        version
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../features/ytt/" class="md-nav__link">
        ytt
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      


  
  
  
    <li class="md-nav__item">
      <a href="../../faq/" class="md-nav__link">
        FAQ
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#create-empty-project-directory" class="md-nav__link">
    Create empty project directory
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setup-database" class="md-nav__link">
    Setup database
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#start-watch-mode" class="md-nav__link">
    Start watch mode
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#add-a-named-volume" class="md-nav__link">
    Add a named volume
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#register-binary-from-image" class="md-nav__link">
    Register binary from image
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#workaround-permission-issues" class="md-nav__link">
    Workaround permission issues
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setup-php-apache-and-symfony-skeleton" class="md-nav__link">
    Setup PHP, Apache and Symfony Skeleton
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setup-vuejs-and-vue-cli" class="md-nav__link">
    Setup VueJS and Vue CLI
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/gfi-centre-ouest/docker-devbox-ddb/blob/develop/docs/guides/psql-symfony-vue.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="guide">Guide<a class="headerlink" href="#guide" title="Permanent link">&para;</a></h1>
<p><strong><em>PostgreSQL, Symfony, VueJS</em></strong></p>
<p>This guide sources are <a href="https://github.com/gfi-centre-ouest/ddb-guide-psql-symfony-vue">available on github</a>.</p>
<h2 id="create-empty-project-directory">Create empty project directory<a class="headerlink" href="#create-empty-project-directory" title="Permanent link">&para;</a></h2>
<p>First of all, you need an empty directory for your project.</p>
<div class="highlight"><pre><span></span><code>mkdir ddb-guide
<span class="nb">cd</span> ddb-guide
</code></pre></div>
<h2 id="setup-database">Setup database<a class="headerlink" href="#setup-database" title="Permanent link">&para;</a></h2>
<p>You should now setup the database container. Create <code>docker-compose.yml.jsonnet</code> file, and add the following content:</p>
<div class="highlight"><pre><span></span><code><span class="err">local</span> <span class="err">ddb</span> <span class="err">=</span> <span class="err">impor</span><span class="kc">t</span> <span class="err">&#39;ddb.docker.libjso</span><span class="kc">nnet</span><span class="err">&#39;;</span>

<span class="err">ddb.Compose(</span><span class="p">{</span>
  <span class="err">services</span><span class="p">:</span> <span class="p">{</span>
    <span class="err">db</span><span class="p">:</span> <span class="err">ddb.Image(</span><span class="s2">&quot;postgres&quot;</span><span class="err">)</span>
  <span class="p">}</span>
<span class="p">}</span><span class="err">)</span>
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Jsonet, a data templating language</p>
<p>Instead of defining containers right inside <code>docker-compose.yml</code> with yaml, ddb is using
<a href="https://jsonnet.org/">Jsonnet</a>, a data templating language. Inside the jsonnet file, a library is imported to
bring handy features and consistent behavior for all containers while reducing verbosity.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Jsonet is embedded into ddb</p>
<p><a href="https://jsonnet.org/">Jsonnet</a> is embedded into ddb. You only have to use the right file extension for ddb to 
process it through the appropriate template engine.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Other template languages are supported</p>
<p>ddb embeds other templating languages, like 
<a href="https://jinja.palletsprojects.com/">Jinja</a> and <a href="https://get-ytt.io/">ytt</a>. But for building the 
<code>docker-compose.yml</code> file, <a href="https://jsonnet.org/">Jsonnet</a> is the best choice and brings access to all features 
from ddb.</p>
</div>
<p>Run the ddb <code>configure</code> command</p>
<div class="highlight"><pre><span></span><code>ddb configure
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Commands</p>
<p>ddb is a command line tool, and implements many commands. <code>configure</code> is the main one. It configures the 
whole project based on available files in the project directory.</p>
</div>
<p><code>docker-compose.yml</code> file has been generated.</p>
<div class="highlight"><pre><span></span><code><span class="nt">networks</span><span class="p">:</span> <span class="p p-Indicator">{}</span>
<span class="nt">services</span><span class="p">:</span>
  <span class="nt">db</span><span class="p">:</span>
    <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">postgres</span>
    <span class="nt">init</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
    <span class="nt">restart</span><span class="p">:</span> <span class="s">&#39;no&#39;</span>
<span class="nt">version</span><span class="p">:</span> <span class="s">&#39;3.7&#39;</span>
<span class="nt">volumes</span><span class="p">:</span> <span class="p p-Indicator">{}</span>
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">.gitignore automation for generated files</p>
<p>You may have noticed that a <code>.gitignore</code> has also been generated, to exclude <code>docker-compose.yml</code>. ddb may generates
many files from templates. When ddb generates a file, it will always be added to the <code>.gitignore</code> file.</p>
</div>
<p>Launch the stack with docker-compose, and check database logs.</p>
<div class="highlight"><pre><span></span><code>docker-compose up -d
docker-compose logs db
</code></pre></div>
<p>Sadly, there's an error in logs and container has stopped. You only have to define a database password with environment 
variable <code>POSTGRES_PASSWORD</code>.</p>
<p>Add this environment variable to <code>docker-compose.yml.jsonnet</code> template.</p>
<div class="highlight"><pre><span></span><code><span class="err">local</span> <span class="err">ddb</span> <span class="err">=</span> <span class="err">impor</span><span class="kc">t</span> <span class="err">&#39;ddb.docker.libjso</span><span class="kc">nnet</span><span class="err">&#39;;</span>

<span class="err">ddb.Compose(</span><span class="p">{</span>
  <span class="err">services</span><span class="p">:</span> <span class="p">{</span>
    <span class="err">db</span><span class="p">:</span> <span class="err">ddb.Image(</span><span class="s2">&quot;postgres&quot;</span><span class="err">)</span> <span class="err">+</span>
    <span class="p">{</span>
      <span class="err">e</span><span class="kc">n</span><span class="err">viro</span><span class="kc">n</span><span class="err">me</span><span class="kc">nt</span><span class="err">+</span><span class="p">:</span> <span class="p">{</span><span class="err">POSTGRES_PASSWORD</span><span class="p">:</span> <span class="s2">&quot;ddb&quot;</span><span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span><span class="err">)</span>
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Jsonnet</p>
<p>You may feel uncomfortable at first with <a href="https://jsonnet.org/">Jsonnet</a>, but this is a great tool and it brings a 
huge value to ddb.</p>
<p>Here, we are merging the json object returned by <code>ddb.Image("postgres")</code> with another object containing an<br />
<code>environment</code> key with environment variable values. </p>
<p><code>+</code> behind <code>environment</code> key name means that values from the new object are appended to values from the source one, 
instead of beeing replaced.</p>
<p>To fully understand syntax and capabilities of jsonnet, you should <a href="https://jsonnet.org/learning/tutorial.html">take time to learn it</a>.</p>
</div>
<p>Run <code>configure</code> command again.</p>
<div class="highlight"><pre><span></span><code>ddb configure
</code></pre></div>
<p>The generated <code>docker-compose.yml</code> file should now look like this:</p>
<div class="highlight"><pre><span></span><code><span class="nt">networks</span><span class="p">:</span> <span class="p p-Indicator">{}</span>
<span class="nt">services</span><span class="p">:</span>
  <span class="nt">db</span><span class="p">:</span>
    <span class="nt">environment</span><span class="p">:</span>
      <span class="nt">POSTGRES_PASSWORD</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ddb</span>
    <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">postgres</span>
    <span class="nt">init</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
    <span class="nt">restart</span><span class="p">:</span> <span class="s">&#39;no&#39;</span>
<span class="nt">version</span><span class="p">:</span> <span class="s">&#39;3.7&#39;</span>
<span class="nt">volumes</span><span class="p">:</span> <span class="p p-Indicator">{}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>docker-compose up -d
docker-compose logs db
</code></pre></div>
<p>The database should be up now ! Great :)</p>
<h2 id="start-watch-mode">Start watch mode<a class="headerlink" href="#start-watch-mode" title="Permanent link">&para;</a></h2>
<p>As you now understand how ddb basics works, you may feel that running the <code>ddb configure</code> after each change is annoying.</p>
<p>I'm pretty sure you want to stay a happy developer, so open a new interpreter, cd inside project directory, and run 
<code>configure</code> command with <code>--watch</code> flag.</p>
<div class="highlight"><pre><span></span><code>ddb --watch configure
</code></pre></div>
<p>ddb is now running and listening for file events inside the project. </p>
<p>Try to change database password inside the <code>docker-compose.yml.jsonnet</code> template file, it will immediately refresh 
<code>docker-compose.yml</code>. That's what we call <em>Watch mode</em>.</p>
<h2 id="add-a-named-volume">Add a named volume<a class="headerlink" href="#add-a-named-volume" title="Permanent link">&para;</a></h2>
<p>As you may already know, you need to setup a volume for data to be persisted if the container is destroyed. </p>
<p>Let's stop and destroy all containers for now.</p>
<div class="highlight"><pre><span></span><code>docker-compose down
</code></pre></div>
<p>Map a named volume to the <code>db</code> service inside <code>docker-compose.yml.jsonnet</code>.</p>
<div class="highlight"><pre><span></span><code><span class="err">local</span> <span class="err">ddb</span> <span class="err">=</span> <span class="err">impor</span><span class="kc">t</span> <span class="err">&#39;ddb.docker.libjso</span><span class="kc">nnet</span><span class="err">&#39;;</span>

<span class="err">ddb.Compose(</span><span class="p">{</span>
    <span class="err">services</span><span class="p">:</span> <span class="p">{</span>
        <span class="err">db</span><span class="p">:</span> <span class="err">ddb.Image(</span><span class="s2">&quot;postgres&quot;</span><span class="err">)</span>
          <span class="p">{</span>
            <span class="err">e</span><span class="kc">n</span><span class="err">viro</span><span class="kc">n</span><span class="err">me</span><span class="kc">nt</span><span class="err">+</span><span class="p">:</span> <span class="p">{</span><span class="err">POSTGRES_PASSWORD</span><span class="p">:</span> <span class="s2">&quot;ddb&quot;</span><span class="p">},</span>
            <span class="err">volumes+</span><span class="p">:</span> <span class="p">[</span><span class="err">&#39;db</span><span class="mi">-</span><span class="err">da</span><span class="kc">ta</span><span class="p">:</span><span class="err">/var/lib/pos</span><span class="kc">t</span><span class="err">gresql/da</span><span class="kc">ta</span><span class="err">&#39;</span><span class="p">]</span>
          <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span><span class="err">)</span>
</code></pre></div>
<p>Thanks to watch mode, changes are immediately generated in <code>docker-compose.yml</code> file</p>
<div class="highlight"><pre><span></span><code><span class="nt">networks</span><span class="p">:</span> <span class="p p-Indicator">{}</span>
<span class="nt">services</span><span class="p">:</span>
  <span class="nt">db</span><span class="p">:</span>
    <span class="nt">environment</span><span class="p">:</span>
      <span class="nt">POSTGRES_PASSWORD</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ddb</span>
    <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">postgres</span>
    <span class="nt">init</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
    <span class="nt">restart</span><span class="p">:</span> <span class="s">&#39;no&#39;</span>
    <span class="nt">volumes</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">db-data:/var/lib/postgresql/data</span>
<span class="nt">version</span><span class="p">:</span> <span class="s">&#39;3.7&#39;</span>
<span class="nt">volumes</span><span class="p">:</span>
  <span class="nt">db-data</span><span class="p">:</span> <span class="p p-Indicator">{}</span>
</code></pre></div>
<p><code>db-data</code> volume is now mapped on <code>/var/lib/postgresql/data</code> inside <code>db</code> service. And <code>db-data</code> volume 
has also been declared in the main volumes section ! Magic :)</p>
<div class="admonition note">
<p class="admonition-title">In fact, it's not so magic</p>
<p>Those automated behavior provided by <code>docker-compose.yml.jsonnet</code>, like <code>init</code> and <code>restart</code> on each service, 
and global <code>volumes</code> declaration, are handled by ddb jsonnet library through <code>ddb.Compose()</code> function.</p>
<p>For more information, check <a href="../../features/jsonnet/">Jsonnet Feature</a> section.</p>
</div>
<h2 id="register-binary-from-image">Register binary from image<a class="headerlink" href="#register-binary-from-image" title="Permanent link">&para;</a></h2>
<p>Database docker image contains binaries that you may need to run, like ...</p>
<ul>
<li><code>psql</code> - PostgreSQL client binary.</li>
<li><code>pg_dump</code> - PostgreSQL command line tool to export data to a file.</li>
</ul>
<p>With docker-compose or raw docker, it may be really painful to find out the right <code>docker-compose</code> command to run those 
binary from your local environment. You may also have issues to read input data file, or to write output data file.</p>
<p>With ddb, you can register those binaries right into <code>docker-compose.yml.jsonnet</code> to make them accessible from your local 
environment.</p>
<div class="highlight"><pre><span></span><code><span class="err">local</span> <span class="err">ddb</span> <span class="err">=</span> <span class="err">impor</span><span class="kc">t</span> <span class="err">&#39;ddb.docker.libjso</span><span class="kc">nnet</span><span class="err">&#39;;</span>

<span class="err">ddb.Compose(</span><span class="p">{</span>
  <span class="err">services</span><span class="p">:</span> <span class="p">{</span>
    <span class="err">db</span><span class="p">:</span> <span class="err">ddb.Image(</span><span class="s2">&quot;postgres&quot;</span><span class="err">)</span> <span class="err">+</span>
        <span class="err">ddb.Bi</span><span class="kc">nar</span><span class="err">y(</span><span class="s2">&quot;psql&quot;</span><span class="p">,</span> <span class="s2">&quot;/project&quot;</span><span class="p">,</span> <span class="s2">&quot;psql --dbname=postgresql://postgres:ddb@db/postgres&quot;</span><span class="err">)</span> <span class="err">+</span>
        <span class="err">ddb.Bi</span><span class="kc">nar</span><span class="err">y(</span><span class="s2">&quot;pg_dump&quot;</span><span class="p">,</span> <span class="s2">&quot;/project&quot;</span><span class="p">,</span> <span class="s2">&quot;pg_dump --dbname=postgresql://postgres:ddb@db/postgres&quot;</span><span class="err">)</span> <span class="err">+</span>
        <span class="p">{</span>
          <span class="err">e</span><span class="kc">n</span><span class="err">viro</span><span class="kc">n</span><span class="err">me</span><span class="kc">nt</span><span class="err">+</span><span class="p">:</span> <span class="p">{</span><span class="err">POSTGRES_PASSWORD</span><span class="p">:</span> <span class="s2">&quot;ddb&quot;</span><span class="p">},</span>
          <span class="err">volumes+</span><span class="p">:</span> <span class="p">[</span>
            <span class="err">&#39;db</span><span class="mi">-</span><span class="err">da</span><span class="kc">ta</span><span class="p">:</span><span class="err">/var/lib/pos</span><span class="kc">t</span><span class="err">gresql/da</span><span class="kc">ta</span><span class="err">&#39;</span><span class="p">,</span>
            <span class="err">ddb.pa</span><span class="kc">t</span><span class="err">h.projec</span><span class="kc">t</span> <span class="err">+</span> <span class="err">&#39;</span><span class="p">:</span><span class="err">/projec</span><span class="kc">t</span><span class="err">&#39;</span>
          <span class="p">]</span>
        <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span><span class="err">)</span>
</code></pre></div>
<p>You should notice that some binary files have been generated in <code>.bin</code> directory : <code>psql</code> and <code>pg_dump</code>.</p>
<p>Those binaries are available right now on your local environment. You can check their version.</p>
<div class="highlight"><pre><span></span><code>.bin/psql --version
.bin/pg_dump --version
</code></pre></div>
<div class="admonition question">
<p class="admonition-title">But ... What the ... Where is all the docker hard stuff ?</p>
<p>Of course, the docker hard stuff is still there. But it's hidden. ddb generates some shims for those binaries 
available in docker image, so you fell like those binaries are now installed on the project. But when invoking those 
binary shims, it creates a temporary container for the command's lifetime.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Current working directory is mapped</p>
<p>When registering binary from jsonnet this way, the project directory on your local environment should be mounted to 
<code>/project</code> inside the container. The working directory of the container is mapped to the working directory of your 
local environment. This allow ddb to match working directory from local environment and container, so you are able
to access any files through a natural process. </p>
</div>
<div class="admonition note">
<p class="admonition-title">Default arguments</p>
<p><code>--dbname=postgresql://postgres:ddb@db/postgres</code> is added as a default argument to both command, so the commands won't
require any connection settings.</p>
</div>
<p>To bring <code>psql</code> and <code>pg_dump</code> shims into the path, you have to activate the project environment into your interpreter.</p>
<div class="highlight"><pre><span></span><code><span class="k">$(</span>ddb activate<span class="k">)</span>
</code></pre></div>
<p><code>.bin</code> directory is now in the interpreter's <code>PATH</code>, so <code>psql</code> and <code>pg_dump</code> are available anywhere.</p>
<div class="highlight"><pre><span></span><code>psql --version
pg_dump --version
</code></pre></div>
<p>Let's try to perform a dump with <code>pg_dump</code>.</p>
<div class="highlight"><pre><span></span><code>pg_dump -f dump.sql
</code></pre></div>
<p>Great, the dump.sql file appears in your working directory ! Perfect. </p>
<p>But if you check carefully your project directory, there's a problem here ! The dump file has been generated, but it is 
owned by <code>root</code>. You are not allowed to write or delete this file now. </p>
<p>Thanks to <code>sudo</code>, you can do still delete it.</p>
<div class="highlight"><pre><span></span><code>sudo rm dump.sql
</code></pre></div>
<p>But this suck ... As a developer, you are really disappointed ... And you are right. Nobody wants a file to be owned by
<code>root</code> inside the project directory.</p>
<h2 id="workaround-permission-issues">Workaround permission issues<a class="headerlink" href="#workaround-permission-issues" title="Permanent link">&para;</a></h2>
<p>To workaround those permission issues, ddb has automated the installation of <a href="https://github.com/boxboat/fixuid">fixuid</a>
inside a Dockerfile.</p>
<div class="admonition note">
<p class="admonition-title">Docker and permission issues</p>
<p>Permission issues are a common pitfall while using docker on development environments. They are related to the way 
docker works and cannot really be fixed once for all.</p>
</div>
<p>As you know, ddb like templates, so you are going to use <a href="https://jinja.palletsprojects.com/">Jinja</a> for all <code>Dockerfile</code> 
files.</p>
<p>By convention, custom <code>Dockerfile.jinja</code> lies in <code>.docker/&lt;image&gt;</code> directory, where <code>&lt;image&gt;</code> is to be replaced 
with effective image name.</p>
<p>First step, create <code>.docker/postgres/Dockerfile.jinja</code> from postgres base image.</p>
<div class="highlight"><pre><span></span><code><span class="k">FROM</span> <span class="s">postgres</span>
<span class="k">USER</span><span class="s"> postgres</span>
</code></pre></div>
<p>Second step, create <code>.docker/postgres/fixuid.yml</code> file.</p>
<div class="highlight"><pre><span></span><code><span class="nt">user</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">postgres</span>
<span class="nt">group</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">postgres</span>
<span class="nt">paths</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">/</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">/var/lib/postgresql/data</span>
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Fixuid</p>
<p>Fixuid change <code>uid</code> and <code>gid</code> of the container user to match the host user, and it changes files ownerships as 
declared in <code>fixuid.yml</code> configuration file. </p>
<p>Most of the time, <code>user</code> and <code>group</code> defined in the configuration file should match the user defined in Dockerfile, 
and <code>paths</code> should match the root directory and volume directories.</p>
<p>When a <code>fixuid.yml</code> file is available next to a Dockerfile, ddb generates fixuid installation instructions into the 
<code>Dockerfile</code>, and entrypoint is changed to run fixuid before the default entrypoint.  </p>
</div>
<p>Last step, change in <code>docker-compose.yml.jsonnet</code> the service definition to use the newly created Dockerfile
(<code>ddb.Image("postgres")</code> replaced to <code>ddb.Build("postgres")</code>), and set <code>user</code> to the host user uid/gid (<code>ddb.User()</code>).</p>
<div class="highlight"><pre><span></span><code><span class="err">local</span> <span class="err">ddb</span> <span class="err">=</span> <span class="err">impor</span><span class="kc">t</span> <span class="err">&#39;ddb.docker.libjso</span><span class="kc">nnet</span><span class="err">&#39;;</span>

<span class="err">ddb.Compose(</span><span class="p">{</span>
    <span class="err">services</span><span class="p">:</span> <span class="p">{</span>
        <span class="err">db</span><span class="p">:</span> <span class="err">ddb.Build(</span><span class="s2">&quot;postgres&quot;</span><span class="err">)</span> <span class="err">+</span> <span class="err">ddb.User()</span> <span class="err">+</span>
            <span class="err">ddb.Bi</span><span class="kc">nar</span><span class="err">y(</span><span class="s2">&quot;psql&quot;</span><span class="p">,</span> <span class="s2">&quot;/project&quot;</span><span class="p">,</span> <span class="s2">&quot;psql --dbname=postgresql://postgres:ddb@db/postgres&quot;</span><span class="err">)</span> <span class="err">+</span>
            <span class="err">ddb.Bi</span><span class="kc">nar</span><span class="err">y(</span><span class="s2">&quot;pg_dump&quot;</span><span class="p">,</span> <span class="s2">&quot;/project&quot;</span><span class="p">,</span> <span class="s2">&quot;pg_dump --dbname=postgresql://postgres:ddb@db/postgres&quot;</span><span class="err">)</span> <span class="err">+</span>
          <span class="p">{</span>
            <span class="err">e</span><span class="kc">n</span><span class="err">viro</span><span class="kc">n</span><span class="err">me</span><span class="kc">nt</span><span class="err">+</span><span class="p">:</span> <span class="p">{</span><span class="err">POSTGRES_PASSWORD</span><span class="p">:</span> <span class="s2">&quot;ddb&quot;</span><span class="p">},</span>
            <span class="err">volumes+</span><span class="p">:</span> <span class="p">[</span>
          <span class="err">&#39;db</span><span class="mi">-</span><span class="err">da</span><span class="kc">ta</span><span class="p">:</span><span class="err">/var/lib/pos</span><span class="kc">t</span><span class="err">gresql/da</span><span class="kc">ta</span><span class="err">&#39;</span><span class="p">,</span>
          <span class="err">ddb.pa</span><span class="kc">t</span><span class="err">h.projec</span><span class="kc">t</span> <span class="err">+</span> <span class="err">&#39;</span><span class="p">:</span><span class="err">/projec</span><span class="kc">t</span><span class="err">&#39;</span>
            <span class="p">]</span>
          <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span><span class="err">)</span>
</code></pre></div>
<p>Stop containers, destroy data from existing database, and start again.</p>
<div class="highlight"><pre><span></span><code>docker-compose down -v
docker-compose up -d
</code></pre></div>
<p>Perform the dump.</p>
<div class="highlight"><pre><span></span><code>pg_dump -f dump.sql
</code></pre></div>
<p><code>dump.sql</code> is now owned by your own user, and as a developer, you are happy again :)</p>
<h2 id="setup-php-apache-and-symfony-skeleton">Setup PHP, Apache and Symfony Skeleton<a class="headerlink" href="#setup-php-apache-and-symfony-skeleton" title="Permanent link">&para;</a></h2>
<p>Then, we need to setup PHP FPM with it's related web server Apache.</p>
<p>So, we are creating a new <code>php</code> service inside <code>docker-compose.yml.jsonnet</code>, based on a Dockerfile build.</p>
<div class="highlight"><pre><span></span><code><span class="err">local</span> <span class="err">ddb</span> <span class="err">=</span> <span class="err">impor</span><span class="kc">t</span> <span class="err">&#39;ddb.docker.libjso</span><span class="kc">nnet</span><span class="err">&#39;;</span>

<span class="err">ddb.Compose(</span><span class="p">{</span>
    <span class="err">services</span><span class="p">:</span> <span class="p">{</span>
        <span class="err">...</span>
        <span class="err">php</span><span class="p">:</span> <span class="err">ddb.Build(</span><span class="s2">&quot;php&quot;</span><span class="err">)</span> <span class="err">+</span>
          <span class="err">ddb.User()</span> <span class="err">+</span>
          <span class="p">{</span>
          <span class="err">volumes+</span><span class="p">:</span> <span class="p">[</span>
            <span class="err">ddb.pa</span><span class="kc">t</span><span class="err">h.projec</span><span class="kc">t</span> <span class="err">+</span> <span class="s2">&quot;:/var/www/html&quot;</span><span class="p">,</span>
            <span class="s2">&quot;php-composer-cache:/composer/cache&quot;</span><span class="p">,</span>
            <span class="s2">&quot;php-composer-vendor:/composer/vendor&quot;</span>
          <span class="p">]</span>
        <span class="p">}</span>
<span class="p">}</span><span class="err">)</span>
</code></pre></div>
<p>And the related <code>Dockerfile.jinja</code> inside <code>.docker/php</code> directory.</p>
<div class="highlight"><pre><span></span><code><span class="k">FROM</span> <span class="s">php:7.3-fpm</span>

<span class="k">RUN</span> docker-php-ext-install opcache
<span class="k">RUN</span> yes <span class="p">|</span> pecl install xdebug <span class="o">&amp;&amp;</span> docker-php-ext-enable xdebug

<span class="k">RUN</span> apt-get update -y <span class="o">&amp;&amp;</span><span class="se">\</span>
 apt-get install -y libpq-dev <span class="o">&amp;&amp;</span><span class="se">\</span>
 rm -rf /var/lib/apt/lists/* <span class="o">&amp;&amp;</span><span class="se">\</span>
 docker-php-ext-install pdo pdo_pgsql

<span class="k">ENV</span> COMPOSER_HOME /composer
<span class="k">ENV</span> PATH /composer/vendor/bin:<span class="nv">$PATH</span>
<span class="k">ENV</span> COMPOSER_ALLOW_SUPERUSER <span class="m">1</span>

<span class="k">COPY</span> --from<span class="o">=</span>composer:2 /usr/bin/composer /usr/bin/composer
<span class="k">RUN</span> apt-get update -y <span class="o">&amp;&amp;</span><span class="se">\</span>
 apt-get install -y git zip unzip <span class="o">&amp;&amp;</span><span class="se">\</span>
 rm -rf /var/lib/apt/lists/*

<span class="k">RUN</span> mkdir -p <span class="s2">&quot;</span><span class="nv">$COMPOSER_HOME</span><span class="s2">/cache&quot;</span> <span class="se">\</span>
<span class="o">&amp;&amp;</span> mkdir -p <span class="s2">&quot;</span><span class="nv">$COMPOSER_HOME</span><span class="s2">/vendor&quot;</span> <span class="se">\</span>
<span class="o">&amp;&amp;</span> chown -R www-data:www-data <span class="nv">$COMPOSER_HOME</span> <span class="se">\</span>
<span class="o">&amp;&amp;</span> chown -R www-data:www-data /var/www

<span class="k">VOLUME</span><span class="s"> /composer/cache</span>
</code></pre></div>
<p>And <code>fixuid.yml</code> to fix file permission issues.</p>
<div class="highlight"><pre><span></span><code><span class="nt">user</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">www-data</span>
<span class="nt">group</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">www-data</span>
<span class="nt">paths</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">/</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">/composer/cache</span>
</code></pre></div>
<p>Then build the docker image with <code>docker-compose build</code>.</p>
<p>Composer has been installed in the image, so let's make it available by registering a binary into 
<code>docker-compose.yml.jsonnet</code>. We can also register the <code>php</code> binary for it to be available locally too.</p>
<div class="highlight"><pre><span></span><code>local ddb = import &#39;ddb.docker.libjsonnet&#39;;

ddb.Compose({
    services: {
        ...
        php: ddb.Build(&quot;php&quot;) +
             ddb.User() +
             ddb.Binary(&quot;composer&quot;, &quot;/var/www/html&quot;, &quot;composer&quot;) +
             ddb.Binary(&quot;php&quot;, &quot;/var/www/html&quot;, &quot;php&quot;) +
             {
              volumes+: [
                 ddb.path.project + &quot;:/var/www/html&quot;,
                 &quot;php-composer-cache:/composer/cache&quot;,
                 &quot;php-composer-vendor:/composer/vendor&quot;
              ]
             }
        },
})
</code></pre></div>
<p>And activate the project, with <code>$(ddb activate)</code>. The composer command in now available right in your PATH.</p>
<div class="highlight"><pre><span></span><code>$ composer --version
Composer version <span class="m">1</span>.10.10 <span class="m">2020</span>-08-03 <span class="m">11</span>:35:19

$ php --version
PHP <span class="m">7</span>.3.10 <span class="o">(</span>cli<span class="o">)</span> <span class="o">(</span>built: Oct <span class="m">17</span> <span class="m">2019</span> <span class="m">15</span>:09:28<span class="o">)</span> <span class="o">(</span> NTS <span class="o">)</span>
Copyright <span class="o">(</span>c<span class="o">)</span> <span class="m">1997</span>-2018 The PHP Group
Zend Engine v3.3.10, Copyright <span class="o">(</span>c<span class="o">)</span> <span class="m">1998</span>-2018 Zend Technologies
    with Xdebug v2.9.6, Copyright <span class="o">(</span>c<span class="o">)</span> <span class="m">2002</span>-2020, by Derick Rethans
</code></pre></div>
<p>Now PHP and composer are available, you can generate the symfony skeleton inside a <code>backend</code> directory.</p>
<div class="highlight"><pre><span></span><code>composer create-project symfony/skeleton backend
</code></pre></div>
<p>We also need a <code>web</code> service for Apache configured with PHP. Here's the <code>docker-compose.yml.jsonnet</code> part.</p>
<div class="highlight"><pre><span></span><code><span class="err">local</span> <span class="err">ddb</span> <span class="err">=</span> <span class="err">impor</span><span class="kc">t</span> <span class="err">&#39;ddb.docker.libjso</span><span class="kc">nnet</span><span class="err">&#39;;</span>

<span class="err">local</span> <span class="err">domai</span><span class="kc">n</span><span class="err">_ex</span><span class="kc">t</span> <span class="err">=</span> <span class="err">s</span><span class="kc">t</span><span class="err">d.ex</span><span class="kc">t</span><span class="err">Var(</span><span class="s2">&quot;core.domain.ext&quot;</span><span class="err">);</span>
<span class="err">local</span> <span class="err">domai</span><span class="kc">n</span><span class="err">_sub</span> <span class="err">=</span> <span class="err">s</span><span class="kc">t</span><span class="err">d.ex</span><span class="kc">t</span><span class="err">Var(</span><span class="s2">&quot;core.domain.sub&quot;</span><span class="err">);</span>

<span class="err">local</span> <span class="err">domai</span><span class="kc">n</span> <span class="err">=</span> <span class="err">s</span><span class="kc">t</span><span class="err">d.joi</span><span class="kc">n</span><span class="err">(&#39;.&#39;</span><span class="p">,</span> <span class="p">[</span><span class="err">domai</span><span class="kc">n</span><span class="err">_sub</span><span class="p">,</span> <span class="err">domai</span><span class="kc">n</span><span class="err">_ex</span><span class="kc">t</span><span class="p">]</span><span class="err">);</span>

<span class="err">ddb.Compose(</span><span class="p">{</span>
    <span class="err">services</span><span class="p">:</span> <span class="p">{</span>
        <span class="err">...</span>
        <span class="err">web</span><span class="p">:</span> <span class="err">ddb.Build(</span><span class="s2">&quot;web&quot;</span><span class="err">)</span> <span class="err">+</span>
             <span class="err">ddb.Vir</span><span class="kc">tual</span><span class="err">Hos</span><span class="kc">t</span><span class="err">(</span><span class="s2">&quot;80&quot;</span><span class="p">,</span> <span class="err">domai</span><span class="kc">n</span><span class="err">)</span>
             <span class="p">{</span>
                  <span class="err">volumes+</span><span class="p">:</span> <span class="p">[</span>
                     <span class="err">ddb.pa</span><span class="kc">t</span><span class="err">h.projec</span><span class="kc">t</span> <span class="err">+</span> <span class="s2">&quot;:/var/www/html&quot;</span><span class="p">,</span>
                     <span class="err">ddb.pa</span><span class="kc">t</span><span class="err">h.projec</span><span class="kc">t</span> <span class="err">+</span> <span class="s2">&quot;/.docker/web/apache.conf:/usr/local/apache2/conf/custom/apache.conf&quot;</span><span class="p">,</span>
                  <span class="p">]</span>
             <span class="p">},</span>
<span class="p">}</span><span class="err">)</span>
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Use std.extVar(...) inside jsonnet to read a configuration property</p>
<p>As you can see here, we are using jsonnet features to build the domain name and setup the traefik configuration for 
the virtualhost. Configuration properties are available inside all template engines and can be listed with 
<code>ddb config --variables</code></p>
</div>
<p>As with the <code>php</code> service, a <code>.docker/web/Dockerfile.jinja</code> is created to define the image build.</p>
<div class="highlight"><pre><span></span><code>FROM httpd:2.4

RUN mkdir -p /usr/local/apache2/conf/custom \
&amp;&amp; mkdir -p /var/www/html \
&amp;&amp; sed -i &#39;/LoadModule proxy_module/s/^#//g&#39; /usr/local/apache2/conf/httpd.conf \
&amp;&amp; sed -i &#39;/LoadModule proxy_fcgi_module/s/^#//g&#39; /usr/local/apache2/conf/httpd.conf \
&amp;&amp; echo &gt;&gt; /usr/local/apache2/conf/httpd.conf &amp;&amp; echo &#39;Include conf/custom/*.conf&#39; &gt;&gt; /usr/local/apache2/conf/httpd.conf

RUN sed -i &#39;/LoadModule headers_module/s/^#//g&#39; /usr/local/apache2/conf/httpd.conf
RUN sed -i &#39;/LoadModule rewrite_module/s/^#//g&#39; /usr/local/apache2/conf/httpd.conf
</code></pre></div>
<p><code>apache.conf</code> specified in docker compose volume mount is also generated from a jinja file, <code>apache.conf.jinja</code>. It is
 used to inject domain name and docker compose network name, for the domain to be centralized into ddb.yml 
 configuration and ease various environment deployements (stage, prod).</p>
<div class="highlight"><pre><span></span><code>&lt;VirtualHost *:80&gt;
  ServerAdmin webmaster@{{core.domain.sub}}.{{core.domain.ext}}
  ServerName api.{{core.domain.sub}}.{{core.domain.ext}}
  DocumentRoot /var/www/html/backend/public

  &lt;Directory &quot;/var/www/html/backend/public/&quot;&gt;
    DirectoryIndex index.php

    AllowOverride All
    Order allow,deny
    Allow from all
    Require all granted

    # symfony configuration from https://github.com/symfony/recipes-contrib/blob/master/symfony/apache-pack/1.0/public/.htaccess

    # By default, Apache does not evaluate symbolic links if you did not enable this
    # feature in your server configuration. Uncomment the following line if you
    # install assets as symlinks or if you experience problems related to symlinks
    # when compiling LESS/Sass/CoffeScript assets.
    # Options FollowSymlinks

    # Disabling MultiViews prevents unwanted negotiation, e.g. &quot;/index&quot; should not resolve
    # to the front controller &quot;/index.php&quot; but be rewritten to &quot;/index.php/index&quot;.
    &lt;IfModule mod_negotiation.c&gt;
        Options -MultiViews
    &lt;/IfModule&gt;

    &lt;IfModule mod_rewrite.c&gt;
        RewriteEngine On

        # Determine the RewriteBase automatically and set it as environment variable.
        # If you are using Apache aliases to do mass virtual hosting or installed the
        # project in a subdirectory, the base path will be prepended to allow proper
        # resolution of the index.php file and to redirect to the correct URI. It will
        # work in environments without path prefix as well, providing a safe, one-size
        # fits all solution. But as you do not need it in this case, you can comment
        # the following 2 lines to eliminate the overhead.
        RewriteCond %{REQUEST_URI}::$1 ^(/.+)/(.*)::\2$
        RewriteRule ^(.*) - [E=BASE:%1]

        # Sets the HTTP_AUTHORIZATION header removed by Apache
        RewriteCond %{HTTP:Authorization} .
        RewriteRule ^ - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]

        # Redirect to URI without front controller to prevent duplicate content
        # (with and without `/index.php`). Only do this redirect on the initial
        # rewrite by Apache and not on subsequent cycles. Otherwise we would get an
        # endless redirect loop (request -&gt; rewrite to front controller -&gt;
        # redirect -&gt; request -&gt; ...).
        # So in case you get a &quot;too many redirects&quot; error or you always get redirected
        # to the start page because your Apache does not expose the REDIRECT_STATUS
        # environment variable, you have 2 choices:
        # - disable this feature by commenting the following 2 lines or
        # - use Apache &gt;= 2.3.9 and replace all L flags by END flags and remove the
        #   following RewriteCond (best solution)
        RewriteCond %{ENV:REDIRECT_STATUS} ^$
        RewriteRule ^index\.php(?:/(.*)|$) %{ENV:BASE}/$1 [R=301,L]

        # If the requested filename exists, simply serve it.
        # We only want to let Apache serve files and not directories.
        RewriteCond %{REQUEST_FILENAME} -f
        RewriteRule ^ - [L]

        # Rewrite all other queries to the front controller.
        RewriteRule ^ %{ENV:BASE}/index.php [L]
    &lt;/IfModule&gt;

    &lt;IfModule !mod_rewrite.c&gt;
        &lt;IfModule mod_alias.c&gt;
            # When mod_rewrite is not available, we instruct a temporary redirect of
            # the start page to the front controller explicitly so that the website
            # and the generated links can still be used.
            RedirectMatch 307 ^/$ /index.php/
            # RedirectTemp cannot be used instead
        &lt;/IfModule&gt;
    &lt;/IfModule&gt;
  &lt;/Directory&gt;

  SetEnvIf Authorization &quot;(.*)&quot; HTTP_AUTHORIZATION=$1

  &lt;FilesMatch \.php$&gt;
      SetHandler &quot;proxy:fcgi://php.{{docker.compose.network_name}}:9000&quot;
  &lt;/FilesMatch&gt;
&lt;/VirtualHost&gt;
</code></pre></div>
<p>And now, we are ready start all containers : <code>docker-compose up -d</code>. </p>
<p>Run <code>ddb info</code> command to check the URL of your virtualhost for the web service.</p>
<p>You should be able to view Symfony landing page at 
<a href="http://api.ddb-quickstart.test">http://ddb-quickstart.test</a> and 
<a href="https://api.ddb-quickstart.test">https://ddb-quickstart.test</a>.</p>
<div class="admonition note">
<p class="admonition-title">You may have to restart traefik container</p>
<p>If you have some issues with certificate validity on the https:// url, you may need to restart traefik container : 
<code>docker restart traefik</code>.</p>
</div>
<h2 id="setup-vuejs-and-vue-cli">Setup VueJS and Vue CLI<a class="headerlink" href="#setup-vuejs-and-vue-cli" title="Permanent link">&para;</a></h2>
<p>To be continued</p>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../../templates/" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Templates
              </div>
            </div>
          </a>
        
        
          <a href="../../features/certs/" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                certs
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            GFI Informatique
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/vendor.93c04032.min.js"></script>
      <script src="../../assets/javascripts/bundle.83e5331e.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}</script>
      
      <script>
        app = initialize({
          base: "../..",
          features: [],
          search: Object.assign({
            worker: "../../assets/javascripts/worker/search.8c7e0a7e.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>